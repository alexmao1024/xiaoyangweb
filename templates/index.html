<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡æ¡£è½¬æ¢å·¥å…·</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container { max-width: 800px; }
        .result-area { max-height: 400px; overflow-y: auto; }
        #uploadForm { margin-top: 20px; }
        .server-status { margin: 20px 0; }
        .hidden { display: none; }
        .format-info { display: none; margin-top: 10px; }
        .progress { height: 20px; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <!-- è¿”å›é¦–é¡µå¯¼èˆª -->
        <nav class="mb-4">
            <a href="/" class="btn btn-outline-secondary">
                ğŸ  è¿”å›å·¥å…·ç®±é¦–é¡µ
            </a>
        </nav>
        
        <h1 class="text-center mb-4">ğŸ“„ æ–‡æ¡£è½¬æ¢å·¥å…·</h1>
        <p class="text-center text-muted">æ”¯æŒå¤šç§æ–‡æ¡£æ ¼å¼çš„åŒå‘è½¬æ¢</p>

        <div id="serverStatus" class="server-status alert alert-warning">
            âŒ› æ­£åœ¨æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...
        </div>

        <div class="card">
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="file" class="form-label">é€‰æ‹©æ–‡ä»¶</label>
                        <input type="file" class="form-control" id="file" name="file" required 
                               accept=".pdf,.docx,.doc,.txt,.md,.html,.xlsx,.xls">
                    </div>
                    <div class="mb-3">
                        <label for="export_format" class="form-label">å¯¼å‡ºæ ¼å¼</label>
                        <select class="form-select" id="export_format" name="export_format">
                            <option value="markdown">Markdown</option>
                            <option value="text">çº¯æ–‡æœ¬</option>
                            <option value="pdf">PDF</option>
                            <option value="docx">Wordæ–‡æ¡£</option>
                            <option value="xlsx">Excelè¡¨æ ¼</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">è½¬æ¢æ–‡æ¡£</button>
                </form>

                <div id="progress" class="mt-3 hidden">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%"></div>
                    </div>
                    <p class="text-center mt-2" id="progressText">æ­£åœ¨è½¬æ¢æ–‡æ¡£...</p>
                </div>

                <div id="error" class="alert alert-danger mt-3 hidden"></div>

                <div id="result" class="mt-3 hidden">
                    <div class="card">
                        <div class="card-header">
                            è½¬æ¢ç»“æœ
                            <button class="btn btn-sm btn-outline-secondary float-end" onclick="copyResult()">
                                å¤åˆ¶å†…å®¹
                            </button>
                        </div>
                        <div class="card-body result-area">
                            <pre id="resultContent"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ–‡ä»¶æ ¼å¼å’Œå¯¹åº”çš„å¯ç”¨å¯¼å‡ºæ ¼å¼æ˜ å°„
        const formatMappings = {
            'pdf': ['MARKDOWN', 'TEXT'],
            'docx': ['MARKDOWN', 'TEXT'],
            'doc': ['MARKDOWN', 'TEXT'],
            'txt': ['MARKDOWN', 'TEXT'],
            'html': ['MARKDOWN', 'TEXT'],
            'md': ['MARKDOWN', 'TEXT', 'PDF', 'DOCX', 'XLSX'],
            'xlsx': ['MARKDOWN', 'TEXT'],
            'xls': ['MARKDOWN', 'TEXT']
        };

        // æ›´æ–°å¯ç”¨çš„å¯¼å‡ºæ ¼å¼
        function updateExportFormats(fileInput) {
            const exportFormatSelect = document.getElementById('export_format');
            const fileName = fileInput.value;
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            exportFormatSelect.innerHTML = '';
            
            if (fileName) {
                const extension = fileName.split('.').pop().toLowerCase();
                const availableFormats = formatMappings[extension] || ['MARKDOWN', 'TEXT'];
                
                // æ·»åŠ å¯ç”¨çš„å¯¼å‡ºæ ¼å¼é€‰é¡¹
                availableFormats.forEach(format => {
                    const option = document.createElement('option');
                    option.value = format;
                    option.textContent = format === 'MARKDOWN' ? 'Markdown' :
                                       format === 'TEXT' ? 'çº¯æ–‡æœ¬' :
                                       format === 'PDF' ? 'PDF' :
                                       format === 'DOCX' ? 'Wordæ–‡æ¡£' :
                                       format === 'XLSX' ? 'Excelè¡¨æ ¼' : format;
                    exportFormatSelect.appendChild(option);
                });
            }
        }

        // ç›‘å¬æ–‡ä»¶é€‰æ‹©å˜åŒ–
        document.getElementById('file').addEventListener('change', function() {
            updateExportFormats(this);
        });

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        async function handleSubmit(event) {
            event.preventDefault();

            const form = document.getElementById('uploadForm');
            const fileInput = document.getElementById('file');
            const exportFormatSelect = document.getElementById('export_format');
            const file = fileInput.files[0];

            if (!file) {
                alert('è¯·é€‰æ‹©è¦è½¬æ¢çš„æ–‡ä»¶');
                return;
            }

            const exportFormat = exportFormatSelect.value;

            // è·å–UIå…ƒç´ 
            const progressContainer = document.getElementById('progress');
            const progressBar = document.querySelector('#progress .progress-bar');
            const progressText = document.getElementById('progressText');
            const errorDiv = document.getElementById('error');
            const submitButton = form.querySelector('button[type="submit"]');

            // é‡ç½®UIçŠ¶æ€
            errorDiv.classList.add('hidden');
            submitButton.disabled = true;
            submitButton.innerHTML = `
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                è½¬æ¢ä¸­...
            `;

            // --- åŠ¨æ€è¿›åº¦æ¡é€»è¾‘ ---
            progressContainer.classList.remove('hidden');
            progressBar.style.transition = 'none'; // å…ˆç§»é™¤è¿‡æ¸¡æ•ˆæœï¼Œä»¥ä¾¿ç«‹å³è®¾ç½®ä¸º0
            progressBar.style.width = '0%';
            // å¼ºåˆ¶æµè§ˆå™¨é‡ç»˜ï¼Œç¡®ä¿åç»­çš„è¿‡æ¸¡åŠ¨ç”»èƒ½ç”Ÿæ•ˆ
            void progressBar.offsetWidth; 
            // è®¾ç½®ä¸€ä¸ªè¾ƒé•¿çš„è¿‡æ¸¡æ—¶é—´æ¥æ¨¡æ‹Ÿè¿›åº¦
            progressBar.style.transition = 'width 15s ease-out';
            progressBar.style.width = '95%'; // åŠ¨ç”»ç›®æ ‡ä¸º95%ï¼Œè¡¨ç¤ºæ­£åœ¨å¤„ç†
            progressText.textContent = 'æ–‡ä»¶ä¸Šä¼ ä¸è½¬æ¢ä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…...';

            const formData = new FormData();
            formData.append('file', file);
            formData.append('export_format', exportFormat.toUpperCase());

            try {
                const response = await fetch('/convert', {
                    method: 'POST',
                    body: formData
                });
                
                // æ— è®ºæˆåŠŸå¤±è´¥ï¼Œéƒ½è®©è¿›åº¦æ¡èµ°å®Œ
                progressBar.style.transition = 'width 0.5s ease-in-out';
                progressBar.style.width = '100%';

                const contentType = response.headers.get('content-type');

                if (response.ok && contentType && !contentType.includes('application/json')) {
                    // å…³é”®ä¿®å¤ï¼šç›´æ¥ä½¿ç”¨åŸå§‹æ–‡ä»¶åæ¥æ„é€ ä¸‹è½½æ–‡ä»¶å
                    const originalName = file.name.split('.').slice(0, -1).join('.');
                    let extension = exportFormat.toLowerCase();
                    if (extension === 'markdown') {
                        extension = 'md';
                    } else if (extension === 'xlsx') {
                        extension = 'xlsx';
                    }
                    const newFileName = `${originalName}.${extension}`;

                    progressText.textContent = 'è½¬æ¢å®Œæˆï¼Œæ­£åœ¨å‡†å¤‡ä¸‹è½½...';
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = newFileName; // ä½¿ç”¨æˆ‘ä»¬è‡ªå·±æ„é€ çš„æ­£ç¡®æ–‡ä»¶å
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                } else if (contentType && contentType.includes('application/json')) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `æœåŠ¡å™¨è¿”å›é”™è¯¯ï¼ŒçŠ¶æ€ç : ${response.status}`);
                } else {
                    const errorText = await response.text();
                    console.error("Unknown server response:", errorText);
                    throw new Error(`å‘ç”ŸæœªçŸ¥é”™è¯¯ï¼ŒæœåŠ¡å™¨å“åº”: ${response.status}`);
                }

            } catch (error) {
                console.error('è½¬æ¢æ“ä½œå¤±è´¥:', error);
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
                
                // å½“è½¬æ¢è¯·æ±‚å‡ºé”™æ—¶ï¼Œæ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
                console.log('è½¬æ¢è¯·æ±‚å‡ºé”™ï¼Œæ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€');
                checkServer();
            } finally {
                // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´éšè—è¿›åº¦æ¡ï¼Œè®©ç”¨æˆ·çœ‹åˆ°100%
                setTimeout(() => {
                    progressContainer.classList.add('hidden');
                    progressBar.style.transition = 'none';
                    progressBar.style.width = '0%';
                }, 1000);

                submitButton.disabled = false;
                submitButton.innerHTML = 'è½¬æ¢æ–‡æ¡£';
            }
        }

        document.getElementById('uploadForm').addEventListener('submit', handleSubmit);

        function copyResult() {
            const resultContent = document.getElementById('resultContent').textContent;
            navigator.clipboard.writeText(resultContent).then(() => {
                alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            });
        }

        // æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        async function checkServer() {
            const statusDiv = document.getElementById('serverStatus');
            
            // æ˜¾ç¤ºæ£€æŸ¥ä¸­çŠ¶æ€
            statusDiv.classList.remove('alert-danger', 'alert-success');
            statusDiv.classList.add('alert-warning');
            statusDiv.innerHTML = 'âŒ› æ­£åœ¨æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...';
            
            try {
                console.log('å¼€å§‹æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€');
                const response = await fetch('/check_server', {
                    method: 'GET',
                    cache: 'no-cache'
                });
                console.log('æ”¶åˆ°æœåŠ¡å™¨å“åº”');
                
                const data = await response.json();
                console.log('æœåŠ¡å™¨çŠ¶æ€:', data.status);
                
                statusDiv.classList.remove('alert-warning', 'alert-danger', 'alert-success');
                if (data.status) {
                    statusDiv.classList.add('alert-success');
                    statusDiv.innerHTML = 'âœ… æœåŠ¡å™¨è¿æ¥æ­£å¸¸';
                } else {
                    statusDiv.classList.add('alert-danger');
                    statusDiv.innerHTML = 'âŒ æœåŠ¡å™¨è¿æ¥å¤±è´¥';
                }
            } catch (error) {
                console.error('æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€å¤±è´¥:', error);
                statusDiv.classList.remove('alert-warning', 'alert-success');
                statusDiv.classList.add('alert-danger');
                statusDiv.innerHTML = 'âŒ æœåŠ¡å™¨è¿æ¥å¤±è´¥';
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        document.addEventListener('DOMContentLoaded', checkServer);
        
        // åœ¨é¡µé¢å®Œå…¨åŠ è½½åä¹Ÿæ£€æŸ¥ä¸€æ¬¡ï¼ˆç¡®ä¿æœåŠ¡å™¨çŠ¶æ€èƒ½æ­£ç¡®æ˜¾ç¤ºï¼‰
        window.onload = checkServer;
        
        // åœ¨é¡µé¢å¯è§æ€§æ”¹å˜æ—¶æ£€æŸ¥ï¼ˆæ¯”å¦‚ä»å…¶ä»–æ ‡ç­¾é¡µåˆ‡å›æ¥æ—¶ï¼Œç›¸å½“äº"åˆ·æ–°"ï¼‰
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                checkServer();
            }
        });
    </script>
</body>
</html> 