<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文档转换工具</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container { max-width: 800px; }
        .result-area { max-height: 400px; overflow-y: auto; }
        #uploadForm { margin-top: 20px; }
        .server-status { margin: 20px 0; }
        .hidden { display: none; }
        .format-info { display: none; margin-top: 10px; }
        .progress { height: 20px; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <!-- 返回首页导航 -->
        <nav class="mb-4">
            <a href="/" class="btn btn-outline-secondary">
                🏠 返回工具箱首页
            </a>
        </nav>
        
        <h1 class="text-center mb-4">📄 文档转换工具</h1>
        <p class="text-center text-muted">支持多种文档格式的双向转换</p>

        <div id="serverStatus" class="server-status alert alert-warning">
            ⌛ 正在检查服务器状态...
        </div>

        <div class="card">
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="file" class="form-label">选择文件</label>
                        <input type="file" class="form-control" id="file" name="file" required 
                               accept=".pdf,.docx,.doc,.txt,.md,.html,.xlsx,.xls">
                    </div>
                    <div class="mb-3">
                        <label for="export_format" class="form-label">导出格式</label>
                        <select class="form-select" id="export_format" name="export_format">
                            <option value="markdown">Markdown</option>
                            <option value="text">纯文本</option>
                            <option value="pdf">PDF</option>
                            <option value="docx">Word文档</option>
                            <option value="xlsx">Excel表格</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">转换文档</button>
                </form>

                <div id="progress" class="mt-3 hidden">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%"></div>
                    </div>
                    <p class="text-center mt-2" id="progressText">正在转换文档...</p>
                </div>

                <div id="error" class="alert alert-danger mt-3 hidden"></div>

                <div id="result" class="mt-3 hidden">
                    <div class="card">
                        <div class="card-header">
                            转换结果
                            <button class="btn btn-sm btn-outline-secondary float-end" onclick="copyResult()">
                                复制内容
                            </button>
                        </div>
                        <div class="card-body result-area">
                            <pre id="resultContent"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 文件格式和对应的可用导出格式映射
        const formatMappings = {
            'pdf': ['MARKDOWN', 'TEXT'],
            'docx': ['MARKDOWN', 'TEXT'],
            'doc': ['MARKDOWN', 'TEXT'],
            'txt': ['MARKDOWN', 'TEXT'],
            'html': ['MARKDOWN', 'TEXT'],
            'md': ['MARKDOWN', 'TEXT', 'PDF', 'DOCX', 'XLSX'],
            'xlsx': ['MARKDOWN', 'TEXT'],
            'xls': ['MARKDOWN', 'TEXT']
        };

        // 更新可用的导出格式
        function updateExportFormats(fileInput) {
            const exportFormatSelect = document.getElementById('export_format');
            const fileName = fileInput.value;
            
            // 清空现有选项
            exportFormatSelect.innerHTML = '';
            
            if (fileName) {
                const extension = fileName.split('.').pop().toLowerCase();
                const availableFormats = formatMappings[extension] || ['MARKDOWN', 'TEXT'];
                
                // 添加可用的导出格式选项
                availableFormats.forEach(format => {
                    const option = document.createElement('option');
                    option.value = format;
                    option.textContent = format === 'MARKDOWN' ? 'Markdown' :
                                       format === 'TEXT' ? '纯文本' :
                                       format === 'PDF' ? 'PDF' :
                                       format === 'DOCX' ? 'Word文档' :
                                       format === 'XLSX' ? 'Excel表格' : format;
                    exportFormatSelect.appendChild(option);
                });
            }
        }

        // 监听文件选择变化
        document.getElementById('file').addEventListener('change', function() {
            updateExportFormats(this);
        });

        // 处理文件上传
        async function handleSubmit(event) {
            event.preventDefault();

            const form = document.getElementById('uploadForm');
            const fileInput = document.getElementById('file');
            const exportFormatSelect = document.getElementById('export_format');
            const file = fileInput.files[0];

            if (!file) {
                alert('请选择要转换的文件');
                return;
            }

            const exportFormat = exportFormatSelect.value;

            // 获取UI元素
            const progressContainer = document.getElementById('progress');
            const progressBar = document.querySelector('#progress .progress-bar');
            const progressText = document.getElementById('progressText');
            const errorDiv = document.getElementById('error');
            const submitButton = form.querySelector('button[type="submit"]');

            // 重置UI状态
            errorDiv.classList.add('hidden');
            submitButton.disabled = true;
            submitButton.innerHTML = `
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                转换中...
            `;

            // --- 动态进度条逻辑 ---
            progressContainer.classList.remove('hidden');
            progressBar.style.transition = 'none'; // 先移除过渡效果，以便立即设置为0
            progressBar.style.width = '0%';
            // 强制浏览器重绘，确保后续的过渡动画能生效
            void progressBar.offsetWidth; 
            // 设置一个较长的过渡时间来模拟进度
            progressBar.style.transition = 'width 15s ease-out';
            progressBar.style.width = '95%'; // 动画目标为95%，表示正在处理
            progressText.textContent = '文件上传与转换中，请耐心等待...';

            const formData = new FormData();
            formData.append('file', file);
            formData.append('export_format', exportFormat.toUpperCase());

            try {
                const response = await fetch('/convert', {
                    method: 'POST',
                    body: formData
                });
                
                // 无论成功失败，都让进度条走完
                progressBar.style.transition = 'width 0.5s ease-in-out';
                progressBar.style.width = '100%';

                const contentType = response.headers.get('content-type');

                if (response.ok && contentType && !contentType.includes('application/json')) {
                    // 关键修复：直接使用原始文件名来构造下载文件名
                    const originalName = file.name.split('.').slice(0, -1).join('.');
                    let extension = exportFormat.toLowerCase();
                    if (extension === 'markdown') {
                        extension = 'md';
                    } else if (extension === 'xlsx') {
                        extension = 'xlsx';
                    }
                    const newFileName = `${originalName}.${extension}`;

                    progressText.textContent = '转换完成，正在准备下载...';
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = newFileName; // 使用我们自己构造的正确文件名
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                } else if (contentType && contentType.includes('application/json')) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `服务器返回错误，状态码: ${response.status}`);
                } else {
                    const errorText = await response.text();
                    console.error("Unknown server response:", errorText);
                    throw new Error(`发生未知错误，服务器响应: ${response.status}`);
                }

            } catch (error) {
                console.error('转换操作失败:', error);
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
                
                // 当转换请求出错时，检查服务器状态
                console.log('转换请求出错，检查服务器状态');
                checkServer();
            } finally {
                // 延迟一点时间隐藏进度条，让用户看到100%
                setTimeout(() => {
                    progressContainer.classList.add('hidden');
                    progressBar.style.transition = 'none';
                    progressBar.style.width = '0%';
                }, 1000);

                submitButton.disabled = false;
                submitButton.innerHTML = '转换文档';
            }
        }

        document.getElementById('uploadForm').addEventListener('submit', handleSubmit);

        function copyResult() {
            const resultContent = document.getElementById('resultContent').textContent;
            navigator.clipboard.writeText(resultContent).then(() => {
                alert('已复制到剪贴板');
            }).catch(err => {
                console.error('复制失败:', err);
                alert('复制失败，请手动复制');
            });
        }

        // 检查服务器状态
        async function checkServer() {
            const statusDiv = document.getElementById('serverStatus');
            
            // 显示检查中状态
            statusDiv.classList.remove('alert-danger', 'alert-success');
            statusDiv.classList.add('alert-warning');
            statusDiv.innerHTML = '⌛ 正在检查服务器状态...';
            
            try {
                console.log('开始检查服务器状态');
                const response = await fetch('/check_server', {
                    method: 'GET',
                    cache: 'no-cache'
                });
                console.log('收到服务器响应');
                
                const data = await response.json();
                console.log('服务器状态:', data.status);
                
                statusDiv.classList.remove('alert-warning', 'alert-danger', 'alert-success');
                if (data.status) {
                    statusDiv.classList.add('alert-success');
                    statusDiv.innerHTML = '✅ 服务器连接正常';
                } else {
                    statusDiv.classList.add('alert-danger');
                    statusDiv.innerHTML = '❌ 服务器连接失败';
                }
            } catch (error) {
                console.error('检查服务器状态失败:', error);
                statusDiv.classList.remove('alert-warning', 'alert-success');
                statusDiv.classList.add('alert-danger');
                statusDiv.innerHTML = '❌ 服务器连接失败';
            }
        }

        // 页面加载时检查服务器状态
        document.addEventListener('DOMContentLoaded', checkServer);
        
        // 在页面完全加载后也检查一次（确保服务器状态能正确显示）
        window.onload = checkServer;
        
        // 在页面可见性改变时检查（比如从其他标签页切回来时，相当于"刷新"）
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                checkServer();
            }
        });
    </script>
</body>
</html> 